# .github/workflows/gemini-write-tests.yml
name: '✍️ Gemini Write Tests'

on:
  workflow_dispatch:
    inputs:
      source_file:
        description: 'Path to the source file to generate tests for (e.g., src/lib.rs)'
        required: false # Made optional
        default: '' # Default to empty string if not provided
  pull_request:
    types: [opened, synchronize, reopened]
    branches:
      - main
  workflow_call:
    inputs:
      source_file:
        description: 'Path to the source file to generate tests for (e.g., src/lib.rs)'
        required: false
        type: string
        default: ''

concurrency:
  group: '${{ github.workflow }}-${{ github.ref }}'
  cancel-in-progress: true

defaults:
  run:
    shell: 'bash'

jobs:
  write_tests:
    runs-on: 'ubuntu-24.04-arm'
    permissions:
      contents: 'write'
      pull-requests: 'write'
      id-token: 'write'
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4'

      - name: 'Mint identity token'
        id: 'mint_identity_token'
        uses: 'actions/create-github-app-token@v2'
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'
          owner: '${{ github.repository_owner }}'

      - name: 'Set SOURCE_FILE environment variable'
        id: set_source_file
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" || "${{ github.event_name }}" == "workflow_call" ]]; then
            echo "SOURCE_FILE=${{ inputs.source_file }}" >> "$GITHUB_ENV"
          else
            echo "SOURCE_FILE=" >> "$GITHUB_ENV"
          fi

      - name: 'Run Gemini CLI Test Writer Agent'
        uses: 'google-github-actions/run-gemini-cli@v0.1.14'
        env:
          GITHUB_TOKEN: '${{ steps.mint_identity_token.outputs.token }}'
          REPOSITORY: '${{ github.repository }}'
          PULL_REQUEST_NUMBER: '${{ github.event.pull_request.number }}'
        with:
          gcp_project_id: '${{ vars.GOOGLE_CLOUD_PROJECT }}'
          gcp_location: '${{ vars.GOOGLE_CLOUD_LOCATION }}'
          gcp_workload_identity_provider: '${{ vars.GCP_WIF_PROVIDER }}'
          gcp_service_account: '${{ secrets.SERVICE_ACCOUNT_EMAIL }}'
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          gemini_model: '${{ vars.GEMINI_MODEL }}'
          settings: |-
            {
              "telemetry": { "enabled": false }
            }
          prompt: |
            You are an expert Rust test engineer. Analyze code, identify untested functions, and write high-quality unit tests.
            
            Repository: ${{ github.repository }}
            Source File: ${{ env.SOURCE_FILE }}
            PR Number: ${{ github.event.pull_request.number || '' }}
            
            Tasks:
            1. Determine target files (from PR changes or SOURCE_FILE)
            2. Create branch (feat/add-tests-for-pr-NUM or feat/add-tests-for-FILE)
            3. For each file: identify untested public functions, add tests to #[cfg(test)] module
            4. Run make test and fix any failures
            5. Commit and create PR with descriptive message
