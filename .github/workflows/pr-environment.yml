name: ðŸŒ± Ephemeral PR Environment

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - closed
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - destroy

env:
  AWS_REGION: ap-southeast-2
  CARGO_TERM_COLOR: always

jobs:
  build-lambda:
    name: ðŸ§± Build Lambda
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.draft == false && github.event.action != 'closed')
    uses: ./.github/workflows/reusable-rust.yml
    with:
      run_tests: true
      run_build: true
      artifact_name: 'pr-lambda-build'

  prepare_pr_environment:
    name: ðŸ”§ Prepare PR Environment
    needs: build-lambda
    uses: ./.github/workflows/reusable-prepare.yml
    with:
      artifact_name: 'pr-lambda-build'
      backend_config_name: 'backend-pr.tfvars'
      environment_name: 'pr-${{ github.event.number }}'
      pr_number: '${{ github.event.number }}'

  terraform_validate_pr:
    name: âœ… Terraform Validate (PR)
    needs: prepare_pr_environment
    if: needs.prepare_pr_environment.outputs.action == 'deploy'
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      command: 'validate'
      backend_config: 'backend-pr.tfvars'

  terraform_plan_pr:
    name: ðŸ“‹ Terraform Plan (PR)
    needs: terraform_validate_pr
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      command: 'plan'
      backend_config: 'backend-pr.tfvars'
      var_file: 'pr-environment.tfvars'

  terraform_apply_pr:
    name: ðŸš€ Terraform Apply (PR)
    needs: terraform_plan_pr
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      command: 'apply'
      backend_config: 'backend-pr.tfvars'
      var_file: 'pr-environment.tfvars'

  post_deployment_steps:
    name: ðŸš€ Post-Deployment Steps
    needs: terraform_apply_pr
    runs-on: ubuntu-slim
    steps:
      - name: ðŸ¥ MCP Health Check
        run: |
          # Get required values from reusable workflow outputs
          CLIENT_ID=${{ needs.terraform_apply_pr.outputs.client_id }}
          TENANT_ID=${{ needs.terraform_apply_pr.outputs.tenant_id }}
          CLIENT_SECRET=${{ needs.terraform_apply_pr.outputs.client_secret }}
          SCOPE=${{ needs.terraform_apply_pr.outputs.scope }}
          GATEWAY_URL=${{ needs.terraform_apply_pr.outputs.gateway_url }}

          # Get OAuth token using client credentials flow
          TOKEN_RESPONSE=$(curl -s -X POST "https://login.microsoftonline.com/$TENANT_ID/oauth2/v2.0/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=$CLIENT_ID" \
            -d "client_secret=$CLIENT_SECRET" \
            -d "grant_type=client_credentials" \
            -d "scope=$SCOPE")

          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r ".access_token")

          # Test MCP initialize call with token
          RESPONSE=$(curl -s -X POST "$GATEWAY_URL/jsonrpc" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"jsonrpc": "2.0", "id": 1, "method": "initialize", "params": {}}')

          # Validate MCP response
          if echo "$RESPONSE" | jq -e '.result' > /dev/null 2>&1; then
            echo "âœ… MCP service healthy"
          else
            echo "âŒ MCP service unhealthy"
            echo "Response: $RESPONSE"
            exit 1
          fi

      - name: ðŸ’¬ Post Deployment Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd iac
          GATEWAY_URL=$(terraform output -raw agentcore_gateway_url 2>/dev/null || echo "unavailable")
          if [ "$GATEWAY_URL" != "unavailable" ]; then
            if [ "${{ needs.prepare_pr_environment.outputs.pr_number }}" != "manual" ]; then
              COMMENT="## ðŸŒ± Ephemeral Environment Deployed

              Your PR environment has been deployed successfully!

              ðŸ”— **Gateway URL**: $GATEWAY_URL

              ðŸ§ª **Testing Instructions**:
              1. Copy the gateway URL below
              2. Launch the MCP Inspector: \`npx @modelcontextprotocol/inspector --transport http --server-url \"$GATEWAY_URL\"\`
              3. Use an OAuth token from your development environment to authenticate in the Inspector UI
              
              ðŸ” **Token Generation**:
              For security reasons, tokens are not automatically generated in CI environments.
              Please use a token from your local development environment or generate one using:
              - Azure CLI: \`az account get-access-token --resource ${{ needs.terraform_apply_pr.outputs.scope }}\`
              - Or use the Azure Portal to generate a test token for your registered application

              ðŸ“‹ **Environment Details**:
              - Environment: \`${{ needs.prepare_pr_environment.outputs.environment_name }}\`
              - Branch: \`${{ github.head_ref }}\`

              â„¹ï¸ This environment will be automatically destroyed when the PR is closed or merged."
            else
              COMMENT="## ðŸŒ± Manual Environment Deployed

              Your manual environment has been deployed successfully!

              ðŸ”— **Gateway URL**: $GATEWAY_URL

              ðŸ§ª **Testing Instructions**:
              1. Copy the gateway URL below
              2. Launch the MCP Inspector: \`npx @modelcontextprotocol/inspector --transport http --server-url \"$GATEWAY_URL\"\`
              3. Use an OAuth token from your development environment to authenticate in the Inspector UI
              
              ðŸ” **Token Generation**:
              For security reasons, tokens are not automatically generated in CI environments.
              Please use a token from your local development environment or generate one using:
              - Azure CLI: \`az account get-access-token --resource ${{ needs.terraform_apply_pr.outputs.scope }}\`
              - Or use the Azure Portal to generate a test token for your registered application

              ðŸ“‹ **Environment Details**:
              - Environment: \`${{ needs.prepare_pr_environment.outputs.environment_name }}\`
              - Run Number: \`${{ github.run_number }}\`

              âš ï¸ **Manual Cleanup Required**: Destroy this environment manually when no longer needed:
              \`\`\`
              gh workflow run pr-environment.yml -f action=destroy
              \`\`\`"
            fi
          else
            if [ "${{ needs.prepare_pr_environment.outputs.pr_number }}" != "manual" ]; then
              COMMENT="## ðŸŒ± Ephemeral Environment Deployment Started
            
              Your PR environment deployment has started. Please wait for completion.
            
              This comment will be updated once the deployment is complete."
            else
              COMMENT="## ðŸŒ± Manual Environment Deployment Started
            
              Your manual environment deployment has started. Please wait for completion.
            
              This comment will be updated once the deployment is complete."
            fi
          fi
          
          if [ "${{ needs.prepare_pr_environment.outputs.pr_number }}" != "manual" ]; then
            # For PRs, add/update comment on the PR
            gh api repos/${{ github.repository }}/issues/${{ needs.prepare_pr_environment.outputs.pr_number }}/comments -f body="$COMMENT" >/dev/null 2>&1 || true
          fi

      - name: ðŸ’¬ Update Comment with Final Details
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd iac
          GATEWAY_URL=$(terraform output -raw agentcore_gateway_url 2>/dev/null || echo "unavailable")
          if [ "$GATEWAY_URL" != "unavailable" ]; then
            if [ "${{ needs.prepare_pr_environment.outputs.pr_number }}" != "manual" ]; then
              COMMENT="## ðŸŒ± Ephemeral Environment Deployed âœ…

              Your PR environment has been deployed successfully!

              ðŸ”— **Gateway URL**: $GATEWAY_URL

              ðŸ§ª **Testing Instructions**:
              1. Copy the gateway URL below
              2. Launch the MCP Inspector: \`npx @modelcontextprotocol/inspector --transport http --server-url \"$GATEWAY_URL\"\`
              3. Use an OAuth token from your development environment to authenticate in the Inspector UI
              
              ðŸ” **Token Generation**:
              For security reasons, tokens are not automatically generated in CI environments.
              Please use a token from your local development environment or generate one using:
              - Azure CLI: \`az account get-access-token --resource ${{ needs.terraform_apply_pr.outputs.scope }}\`
              - Or use the Azure Portal to generate a test token for your registered application

              ðŸ“‹ **Environment Details**:
              - Environment: \`${{ needs.prepare_pr_environment.outputs.environment_name }}\`
              - Branch: \`${{ github.head_ref }}\`

              â„¹ï¸ This environment will be automatically destroyed when the PR is closed or merged."
            else
              COMMENT="## ðŸŒ± Manual Environment Deployed âœ…

              Your manual environment has been deployed successfully!

              ðŸ”— **Gateway URL**: $GATEWAY_URL

              ðŸ§ª **Testing Instructions**:
              1. Copy the gateway URL below
              2. Launch the MCP Inspector: \`npx @modelcontextprotocol/inspector --transport http --server-url \"$GATEWAY_URL\"\`
              3. Use an OAuth token from your development environment to authenticate in the Inspector UI
              
              ðŸ” **Token Generation**:
              For security reasons, tokens are not automatically generated in CI environments.
              Please use a token from your local development environment or generate one using:
              - Azure CLI: \`az account get-access-token --resource ${{ needs.terraform_apply_pr.outputs.scope }}\`
              - Or use the Azure Portal to generate a test token for your registered application

              ðŸ“‹ **Environment Details**:
              - Environment: \`${{ needs.prepare_pr_environment.outputs.environment_name }}\`
              - Run Number: \`${{ github.run_number }}\`

              âš ï¸ **Manual Cleanup Required**: Destroy this environment manually when no longer needed:
              \`\`\`
              gh workflow run pr-environment.yml -f action=destroy
              \`\`\`"
            fi
            
            if [ "${{ needs.prepare_pr_environment.outputs.pr_number }}" != "manual" ]; then
              # For PRs, update the comment on the PR
              gh api repos/${{ github.repository }}/issues/${{ needs.prepare_pr_environment.outputs.pr_number }}/comments -f body="$COMMENT" >/dev/null 2>&1 || true
            fi
          fi

  terraform_destroy_pr:
    name: ðŸ’£ Terraform Destroy (PR)
    needs: prepare_pr_environment
    if: needs.prepare_pr_environment.outputs.action == 'destroy'
    runs-on: ubuntu-slim
    steps:
      - name: ðŸ’£ Terraform Destroy (Environment)
        run: |
          cd iac
          # Create a dummy Lambda binary for validation during destroy
          mkdir -p ../target/lambda/aws-lambda-mcp
          echo "dummy-content-for-destroy-operations" > ../target/lambda/aws-lambda-mcp/bootstrap
           # Initialize Terraform with backend config (without reconfigure to avoid validation)
           terraform init -backend-config=backend-pr.tfvars
           # Destroy infrastructure
           terraform destroy -auto-approve -var-file=pr-environment.tfvars

      - name: ðŸ§¹ Cleanup Terraform State File
        run: |
          # Remove the state file from S3 to prevent accumulation
          STATE_KEY="aws-lambda-mcp/${{ needs.prepare_pr_environment.outputs.environment_name }}/terraform.tfstate"
          echo "Cleaning up Terraform state file: s3://${{ secrets.TF_BACKEND_BUCKET }}/$STATE_KEY"
          aws s3 rm "s3://${{ secrets.TF_BACKEND_BUCKET }}/$STATE_KEY" || echo "State file cleanup may have failed, continuing..."

      - name: ðŸ’¬ Notify Environment Destruction
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ needs.prepare_pr_environment.outputs.pr_number }}" != "manual" ]; then
            COMMENT="## ðŸŒ± Ephemeral Environment Destroyed ðŸ—‘ï¸
          
            Your PR environment has been successfully destroyed.
          
            ðŸ“‹ **Details**:
            - Environment: \`${{ needs.prepare_pr_environment.outputs.environment_name }}\`
            - Branch: \`${{ github.head_ref }}\`
          
            âœ… All resources have been cleaned up."
          
            # Add a final comment to the PR
            gh api repos/${{ github.repository }}/issues/${{ needs.prepare_pr_environment.outputs.pr_number }}/comments -f body="$COMMENT" >/dev/null 2>&1 || true
          fi