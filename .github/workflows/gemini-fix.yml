# .github/workflows/gemini-fix.yml
name: 'ðŸ¤– Gemini Fix'

on:
  workflow_call:
    inputs:
      pull_request_number:
        type: 'number'
        description: 'The number of the pull request to fix'
        required: true
      failure_type:
        type: 'string'
        description: 'The type of failure (e.g., rust-test, terraform-validate)'
        required: true

concurrency:
  group: '${{ github.workflow }}-fix-${{ inputs.pull_request_number }}'
  cancel-in-progress: false

defaults:
  run:
    shell: 'bash'

jobs:
  fix:
    runs-on: 'ubuntu-24.04-arm'
    permissions:
      contents: 'write' # Needs write access to push fixes
      pull-requests: 'write'
      id-token: 'write'
    steps:
      - name: 'Checkout repository'
        uses: 'actions/checkout@v4'

      - name: 'Mint identity token'
        id: 'mint_identity_token'
        uses: 'actions/create-github-app-token@v2'
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'
          owner: '${{ github.repository_owner }}'

      - name: 'Run Gemini CLI Fixer Agent'
        uses: 'google-github-actions/run-gemini-cli@v0.1.14'
        env:
          GITHUB_TOKEN: '${{ steps.mint_identity_token.outputs.token }}'
          PULL_REQUEST_NUMBER: '${{ inputs.pull_request_number }}'
          REPOSITORY: '${{ github.repository }}'
          FAILURE_TYPE: '${{ inputs.failure_type }}'
        with:
          gcp_project_id: '${{ vars.GOOGLE_CLOUD_PROJECT }}'
          gcp_location: '${{ vars.GOOGLE_CLOUD_LOCATION }}'
          gcp_workload_identity_provider: '${{ vars.GCP_WIF_PROVIDER }}'
          gcp_service_account: '${{ secrets.SERVICE_ACCOUNT_EMAIL }}'
          use_gemini_code_assist: true
          gemini_model: '${{ vars.GEMINI_MODEL }}'
          settings: |-
            {
              "telemetry": { "enabled": false }
            }
          prompt: |
            You are an expert AI software engineer fixing a failed build in PR #${{ inputs.pull_request_number }} for ${{ github.repository }}. Failure type: ${{ inputs.failure_type }}.
            
            Tasks:
            1. Checkout PR branch and view PR details and failed workflow logs
            2. Diagnose the problem from logs and dependency changes
            3. Apply code fixes using file operations
            4. Verify fix (make test for rust-test, terraform validate for terraform-validate)
            5. Commit and push changes with message "fix(deps): apply automated fix for dependency update"
            6. Comment on PR with fix summary or failure explanation after 2 attempts
