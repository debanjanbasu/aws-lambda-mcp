name: ðŸ”„ Reusable Terraform Operations
on:
  workflow_call:
    inputs:
      command:
        required: true
        type: string
        description: 'Terraform command to run (init, validate, deploy, destroy)'
      var_file:
        required: false
        type: string
        description: 'Variable file to use'
      aws_region:
        required: false
        type: string
        default: 'ap-southeast-2'
        description: 'AWS region'
      environment_name:
        required: false
        type: string
        description: 'Environment name for state key (e.g., preview-123)'
      artifact_name:
        required: false
        type: string
        description: 'Name of the artifact to download'
      pull_request_number:
        required: false
        type: string
        description: 'Pull Request number for tagging'
    outputs:
      gateway_url:
        description: 'API Gateway URL output'
        value: ${{ jobs.terraform.outputs.gateway_url }}
      project_name:
        description: 'Project name with suffix'
        value: ${{ jobs.terraform.outputs.project_name }}
      client_id:
        description: 'Entra app client ID'
        value: ${{ jobs.terraform.outputs.client_id }}
      scope:
        description: 'Entra app scope'
        value: ${{ jobs.terraform.outputs.scope }}
permissions:
  id-token: write
  contents: read
jobs:
  terraform:
    runs-on: ubuntu-24.04-arm
    env:
      AWS_REGION: ${{ inputs.aws_region }}
    outputs:
      gateway_url: ${{ steps.terraform-outputs.outputs.gateway_url }}
      project_name: ${{ steps.terraform-outputs.outputs.project_name }}
      client_id: ${{ steps.terraform-outputs.outputs.client_id }}
      scope: ${{ steps.terraform-outputs.outputs.scope }}
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v6
      - name: â˜ï¸ Download Lambda Artifacts
        if: inputs.artifact_name && inputs.artifact_name != 'dummy-artifact'
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.artifact_name }}
          path: .
      - name: ðŸ“ Create Environment Variables File
        if: inputs.environment_name
        run: |
          cat > iac/preview-environment.tfvars << EOF
          project_name = "aws-agentcore-gateway-${{ inputs.environment_name }}"
          common_tags = {
            Project     = "aws-agentcore-gateway"
            ManagedBy   = "terraform"
            Environment = "ephemeral-${{ inputs.environment_name }}"
            Pull_Request_Number = "${{ inputs.pull_request_number || github.event.number }}"
            Branch      = "${{ github.head_ref }}"
          }
          EOF
      - name: ðŸ’¾ Cache Terraform plugin cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
          key: ${{ runner.os }}-${{ runner.arch }}-terraform-plugins-${{ inputs.environment_name || 'prod' }}-${{ hashFiles('iac/.terraform.lock.hcl', 'iac/main.tf', 'iac/providers.tf') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-terraform-plugins-${{ inputs.environment_name || 'prod' }}-
            ${{ runner.os }}-${{ runner.arch }}-terraform-plugins-
      - name: ðŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest
      - name: ðŸŽ¨ Terraform Format Check
        if: inputs.command == 'init'
        run: cd iac && terraform fmt -check
      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ inputs.aws_region }}
      - name: ðŸ” Configure Azure Credentials
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true
      - name: ðŸ§¹ Clean cached local terraform state
        run: |
          if [ -d "iac/.terraform" ]; then
            rm -rf iac/.terraform
          fi
      - name: ðŸš€ Terraform Init
        env:
          TF_BACKEND_BUCKET: ${{ secrets.TF_BACKEND_BUCKET }}
          TF_VAR_project_name_suffix: ${{ secrets.PROJECT_NAME_SUFFIX || '' }}
        run: |
          cd iac
          if [ -n "${{ inputs.environment_name }}" ]; then
            STATE_KEY="aws-lambda-mcp/${{ inputs.environment_name }}/terraform.tfstate"
          else
            STATE_KEY="aws-lambda-mcp/terraform.tfstate"
          fi
          # Use -reconfigure for PR environments to handle backend config changes
          # Issue: GitHub Actions caches Terraform state between jobs, but PR environments
          # use different state keys than main environment, causing "Backend configuration changed" errors
          # Solution: Remove any cached local .terraform directory and use -reconfigure for PR envs
          if [ -n "${{ inputs.environment_name }}" ]; then
            terraform init -reconfigure \
              -backend-config="bucket=${TF_BACKEND_BUCKET}" \
              -backend-config="key=${STATE_KEY}" \
              -backend-config="region=${{ inputs.aws_region }}" \
              -backend-config="use_lockfile=true"
          else
            terraform init \
              -backend-config="bucket=${TF_BACKEND_BUCKET}" \
              -backend-config="key=${STATE_KEY}" \
              -backend-config="region=${{ inputs.aws_region }}" \
              -backend-config="use_lockfile=true"
          fi
      - name: ðŸ”“ Check and Clear Stale State Locks
        if: inputs.command == 'deploy' || inputs.command == 'destroy'
        run: |
          cd iac
          echo "Checking for stale state locks..."
          
          # Try to get the current lock info
          LOCK_INFO=$(terraform plan -detailed-exitcode 2>&1 || true)
          
          if echo "$LOCK_INFO" | grep -q "Error acquiring the state lock"; then
            echo "âš ï¸  Stale lock detected. Attempting to recover..."
            
            # Extract lock ID from error message
            LOCK_ID=$(echo "$LOCK_INFO" | grep -oP 'ID:\s+\K[a-f0-9-]+' | head -1)
            
            if [ -n "$LOCK_ID" ]; then
              echo "Found lock ID: $LOCK_ID"
              echo "This is likely from a cancelled workflow. Forcing unlock..."
              terraform force-unlock -force "$LOCK_ID" || echo "Force unlock failed, but continuing..."
              echo "âœ… Lock cleared. Proceeding with operation."
            else
              echo "âŒ Could not extract lock ID. Manual intervention may be required."
              exit 1
            fi
          else
            echo "âœ… No stale locks detected."
          fi
      - name: âœ… Terraform Validate
        if: inputs.command == 'validate' || inputs.command == 'deploy'
        run: cd iac && terraform validate
      - name: ðŸš€ Terraform Deploy (Apply)
        if: inputs.command == 'deploy'
        run: |
          cd iac
          terraform apply -auto-approve ${{ inputs.var_file && format('-var-file={0}', inputs.var_file) || '' }}
      - name: âš™ï¸ Setup Rust toolchain
        if: inputs.command == 'destroy'
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src
      - name: ðŸ“„ Generate Tool Schema (required for Terraform destroy)
        if: inputs.command == 'destroy'
        run: cargo run --bin generate-schema --features schema-gen
      - name: ðŸ’¥ Terraform Destroy
        if: inputs.command == 'destroy'
        run: |
          # Create dummy bootstrap files to satisfy archive_file data sources during destroy
          mkdir -p target/lambda/aws-lambda-mcp
          mkdir -p target/lambda/interceptor
          touch target/lambda/aws-lambda-mcp/bootstrap
          touch target/lambda/interceptor/bootstrap
          cd iac
          terraform destroy -auto-approve ${{ inputs.var_file && format('-var-file={0}', inputs.var_file) || '' }}
      - name: ðŸ“¤ Capture Terraform Outputs
        if: inputs.command == 'deploy'
        id: terraform-outputs
        run: |
          cd iac
          echo "gateway_url=$(terraform output -raw agentcore_gateway_url)" >> $GITHUB_OUTPUT
          echo "project_name=$(terraform output -raw project_name)" >> $GITHUB_OUTPUT
          echo "client_id=$(terraform output -raw entra_app_client_id)" >> $GITHUB_OUTPUT
          echo "scope=$(terraform output -raw entra_app_scope_client_credentials)" >> $GITHUB_OUTPUT
