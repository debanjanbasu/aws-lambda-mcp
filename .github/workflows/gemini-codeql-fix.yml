# .github/workflows/gemini-codeql-fix.yml
name: 'ðŸ¤– Gemini CodeQL Fix'

on:
  workflow_dispatch: # Allow manual triggering
  schedule:
    - cron: '0 8 * * 3' # Run every Wednesday at 8:00 AM

concurrency:
  group: '${{ github.workflow }}'
  cancel-in-progress: true

defaults:
  run:
    shell: 'bash'

jobs:
  dispatch:
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'read'
      security-events: 'read'
    outputs:
      alerts: '${{ steps.find_alerts.outputs.alerts }}'
    steps:
      - name: 'Find open CodeQL alerts'
        id: 'find_alerts'
        env:
          GH_TOKEN: '${{ secrets.GITHUB_TOKEN }}'
        run: |
          ALERTS=$(gh code-scanning alerts --state open --json number,rule,tool,most_recent_instance -q '
            .[] | select(.tool.name == "CodeQL") | {
              number: .number,
              rule_id: .rule.id,
              rule_description: .rule.description,
              file_path: .most_recent_instance.location.path,
              start_line: .most_recent_instance.location.start_line,
              end_line: .most_recent_instance.location.end_line,
              message: .most_recent_instance.message.text
            }
          ')
          # Convert to a compact JSON string for output
          COMPACT_ALERTS=$(echo $ALERTS | jq -c '.')
          echo "alerts=$COMPACT_ALERTS" >> $GITHUB_OUTPUT

  fix:
    needs: [dispatch]
    if: needs.dispatch.outputs.alerts != '[]'
    runs-on: 'ubuntu-latest'
    permissions:
      contents: 'write'
      pull-requests: 'write'
      security-events: 'write' # To dismiss alerts
      id-token: 'write'
    strategy:
      matrix:
        alert: '${{ fromJson(needs.dispatch.outputs.alerts) }}'
      fail-fast: false
    steps:
      - name: 'Mint identity token'
        id: 'mint_identity_token'
        uses: 'actions/create-github-app-token@v2'
        with:
          app-id: '${{ vars.APP_ID }}'
          private-key: '${{ secrets.APP_PRIVATE_KEY }}'
          owner: '${{ github.repository_owner }}'

      - name: 'Run Gemini CLI CodeQL Fixer Agent'
        uses: 'google-github-actions/run-gemini-cli@v0.1.14'
        env:
          GITHUB_TOKEN: '${{ steps.mint_identity_token.outputs.token }}'
          REPOSITORY: '${{ github.repository }}'
          ALERT_CONTEXT: '${{ toJSON(matrix.alert) }}'
        with:
          gcp_project_id: '${{ vars.GOOGLE_CLOUD_PROJECT }}'
          gcp_location: '${{ vars.GOOGLE_CLOUD_LOCATION }}'
          gcp_workload_identity_provider: '${{ vars.GCP_WIF_PROVIDER }}'
          gcp_service_account: '${{ vars.SERVICE_ACCOUNT_EMAIL }}'
          gemini_api_key: '${{ secrets.GEMINI_API_KEY }}'
          gemini_model: '${{ vars.GEMINI_MODEL }}'
          settings: |-
            {
              "telemetry": { "enabled": false }
            }
          prompt: |-
            ## Role: Autonomous Code Security Engineer

            You are an expert AI agent specializing in code security. Your task is to fix a CodeQL alert in the main branch of a repository.

            ## Primary Directive

            Your goal is to analyze the provided CodeQL alert, write a secure code patch, create a pull request with the fix, and dismiss the alert.

            ## Input Data

            - **Repository**: ${{ env.REPOSITORY }}
            - **CodeQL Alert (JSON)**: ${{ env.ALERT_CONTEXT }}

            ## Execution Workflow

            1.  **Parse the Alert:**
                - The `ALERT_CONTEXT` variable contains a JSON object with the full details of the alert, including the rule, file path, and line numbers.

            2.  **Create a Branch:**
                - Create a new branch for your fix. The branch name should be descriptive, like `fix/codeql-alert-${{ fromJson(env.ALERT_CONTEXT).number }}`. Use `gh pr create --no-verify` or similar git commands.

            3.  **Analyze and Fix the Code:**
                - Check out the new branch.
                - Read the contents of the file identified in `file_path`.
                - Analyze the code in the context of the security rule (`rule_id` and `rule_description`).
                - Use `read_file` and `replace` to apply a secure patch to the code.

            4.  **Verify the Fix:**
                - Run `make test` to ensure your change has not broken any existing functionality. This is a critical step. Do not skip it.

            5.  **Create a Pull Request:**
                - Commit your changes with a message like `fix(security): Address CodeQL alert #${{ fromJson(env.ALERT_CONTEXT).number }}`.
                - Push the branch to the remote repository.
                - Create a new pull request. The body of the PR should clearly state which CodeQL alert it fixes, referencing the alert number. Use `gh pr create --title "..." --body "..."`.

            6.  **Dismiss the Alert:**
                - Once the PR is created, use the GitHub CLI to dismiss the original alert as "fixed".
                - `gh code-scanning alert dismiss ${{ fromJson(env.ALERT_CONTEXT).number }} --reason "fixed" --comment "Fix proposed in PR #[PR_NUMBER]."`
                - You will need to get the `[PR_NUMBER]` from your previous step.
