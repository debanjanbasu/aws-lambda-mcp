name: ðŸš€ Deploy AWS Lambda MCP

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'Makefile'
      - 'iac/**'
  workflow_dispatch: # Allows manual triggering

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: ap-southeast-2 # Default AWS region, can be overridden
  CARGO_TERM_COLOR: always # Ensure Rust color output is consistent

jobs:
  build-lambda:
    name: ðŸ§± Build Lambda
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/reusable-rust.yml
    with:
      run_tests: true
      run_build: true
      artifact_name: 'lambda-build'

  terraform_deploy:
    name: ðŸš€ Terraform Deploy
    needs: build-lambda
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      command: 'deploy'
      aws_region: ${{ vars.AWS_REGION || 'ap-southeast-2' }}
      artifact_name: 'lambda-build'
    secrets: inherit

  e2e_test:
    name: ðŸ§ª E2E Test
    needs: terraform_deploy
    uses: ./.github/workflows/reusable-e2e-test.yml
    with:
      gateway_url: ${{ needs.terraform_deploy.outputs.gateway_url }}
      scope: ${{ needs.terraform_deploy.outputs.scope }}
      client_id: ${{ needs.terraform_deploy.outputs.client_id }}
      environment_name: 'production'
    secrets: inherit