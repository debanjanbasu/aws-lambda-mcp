name: ğŸŒ± Ephemeral PR Environment

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - closed
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - destroy

env:
  AWS_REGION: ap-southeast-2
  CARGO_TERM_COLOR: always

jobs:
  build-lambda:
    name: ğŸ§± Build Lambda
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'pull_request' && github.event.pull_request.draft == false && github.event.action != 'closed')
    uses: ./.github/workflows/reusable-rust.yml
    with:
      run_tests: true
      run_build: true
      artifact_name: 'pr-lambda-build'

  terraform_validate_pr:
    name: âœ… Terraform Validate (PR)
    needs: build-lambda
    if: github.event.action != 'closed'
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      command: 'validate'
      environment_name: 'pr-${{ github.event.number }}'
      artifact_name: 'pr-lambda-build'
      pr_number: '${{ github.event.number }}'
    secrets: inherit

  terraform_apply_pr:
    name: ğŸš€ Terraform Apply (PR)
    needs: terraform_validate_pr
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      command: 'deploy'
      var_file: 'pr-environment.tfvars'
      environment_name: 'pr-${{ github.event.number }}'
      artifact_name: 'pr-lambda-build'
      pr_number: '${{ github.event.number }}'
    secrets: inherit

  post_deployment_steps:
    name: ğŸš€ Post-Deployment Steps
    needs: terraform_apply_pr
    runs-on: ubuntu-24.04-arm
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - name: ğŸ” Configure Azure Credentials
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: ğŸ”‘ Get OAuth Token
        id: get-token
        run: |
          SCOPE=${{ needs.terraform_apply_pr.outputs.scope }}
          TOKEN=$(az account get-access-token --scope "$SCOPE" --query accessToken -o tsv)
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: ğŸ§ª E2E Test - Weather Tool
        run: |
          GATEWAY_URL="${{ needs.terraform_apply_pr.outputs.gateway_url }}"
          PROJECT_NAME="${{ needs.terraform_apply_pr.outputs.project_name }}"
          GATEWAY_ID="${{ needs.terraform_apply_pr.outputs.gateway_id }}"
          TARGET_ID="${{ needs.terraform_apply_pr.outputs.target_id }}"
          TOKEN="${{ steps.get-token.outputs.token }}"
          
          # Tool naming: {gateway-id}_{target-id}___tool-name
          TOOL_NAME="${GATEWAY_ID}_${TARGET_ID}___get_weather"
          
          echo "Testing weather tool via AgentCore Gateway..."
          echo "Tool name: $TOOL_NAME"
          RESPONSE=$(curl -s -X POST "$GATEWAY_URL" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"jsonrpc\": \"2.0\",
              \"id\": 1,
              \"method\": \"tools/call\",
              \"params\": {
                \"name\": \"${TOOL_NAME}\",
                \"arguments\": {
                  \"location\": \"Sydney\"
                }
              }
            }")
          
          echo "Response: $RESPONSE"
          
          # Check if response contains expected fields
          if echo "$RESPONSE" | jq -e '.result.content[0].text' >/dev/null 2>&1; then
            echo "âœ… E2E test passed - received valid weather response"
          else
            echo "âŒ E2E test failed - invalid response"
            exit 1
          fi

      - name: ğŸ’¬ Post Deployment Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          GATEWAY_URL=${{ needs.terraform_apply_pr.outputs.gateway_url }}
          CLIENT_ID=${{ needs.terraform_apply_pr.outputs.client_id }}
          SCOPE=${{ needs.terraform_apply_pr.outputs.scope }}
          
          COMMENT="## ğŸŒ± Ephemeral Environment Deployed âœ…

          Your PR environment has been deployed successfully!

          ğŸ”— **Gateway URL**: $GATEWAY_URL

          ğŸ§ª **Testing Instructions**:
          1. Copy the gateway URL above
          2. Launch the MCP Inspector: \`npx @modelcontextprotocol/inspector --transport http --server-url \"$GATEWAY_URL\"\`
          3. Use an OAuth token to authenticate in the Inspector UI
          
          ğŸ” **Token Generation** (run locally with Azure CLI):
          \`\`\`bash
          # Recommended: Use Azure CLI with the PR environment's scope
          az account get-access-token --resource $SCOPE --query accessToken -o tsv
          
          # Alternative: Manual client credentials flow (requires client secret from Terraform output)
          curl -X POST \"https://login.microsoftonline.com/${{ secrets.AZURE_TENANT_ID }}/oauth2/v2.0/token\" \\
            -H \"Content-Type: application/x-www-form-urlencoded\" \\
            -d \"client_id=$CLIENT_ID\" \\
            -d \"client_secret=<CLIENT_SECRET_FROM_TERRAFORM_OUTPUT>\" \\
            -d \"grant_type=client_credentials\" \\
            -d \"scope=$SCOPE\"
          \`\`\`

          ğŸ“‹ **Environment Details**:
          - Environment: \`pr-${{ github.event.number }}\`
          - Branch: \`${{ github.head_ref }}\`
          - Client ID: \`$CLIENT_ID\`
          - Scope: \`$SCOPE\`

          â„¹ï¸ This environment will be automatically destroyed when the PR is closed or merged."
          
          gh api repos/${{ github.repository }}/issues/${{ github.event.number }}/comments -f body="$COMMENT" >/dev/null 2>&1 || true

  terraform_destroy_pr:
    name: ğŸ’£ Terraform Destroy (PR)
    if: github.event.action == 'closed'
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      command: 'destroy'
      var_file: 'pr-environment.tfvars'
      environment_name: 'pr-${{ github.event.number }}'
      pr_number: '${{ github.event.number }}'
    secrets: inherit

  cleanup_pr_environment:
    name: ğŸ§¹ Cleanup PR Environment
    needs: terraform_destroy_pr
    if: github.event.action == 'closed'
    runs-on: ubuntu-24.04-arm
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ğŸ§¹ Cleanup Terraform State File
        run: |
          STATE_KEY="aws-lambda-mcp/pr-${{ github.event.number }}/terraform.tfstate"
          echo "Cleaning up Terraform state file: s3://${{ secrets.TF_BACKEND_BUCKET }}/$STATE_KEY"
          aws s3 rm "s3://${{ secrets.TF_BACKEND_BUCKET }}/$STATE_KEY" || echo "State file cleanup may have failed, continuing..."

      - name: ğŸ’¬ Notify Environment Destruction
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT="## ğŸŒ± Ephemeral Environment Destroyed ğŸ—‘ï¸
        
          Your PR environment has been successfully destroyed.
        
          ğŸ“‹ **Details**:
          - Environment: \`pr-${{ github.event.number }}\`
          - Branch: \`${{ github.head_ref }}\`
        
          âœ… All resources have been cleaned up."
        
          gh api repos/${{ github.repository }}/issues/${{ github.event.number }}/comments -f body="$COMMENT" >/dev/null 2>&1 || true