name: "ðŸ”‘ Reusable: GitHub App Installation Token"

on:
  workflow_call:
    secrets:
      APP_ID:
        required: true
      APP_PRIVATE_KEY:
        required: true
    outputs:
      installation_token:
        description: "Short-lived installation access token"
        value: ${{ jobs.make_token.outputs.installation_token }}

jobs:
  make_token:
    runs-on: ubuntu-24.04-arm
    permissions:
      id-token: write
      contents: read
    outputs:
      installation_token: ${{ steps.request_token.outputs.token }}
    steps:
      - name: ðŸ” Prepare private key
        id: write_key
        env:
          APP_PRIVATE_KEY: ${{ secrets.APP_PRIVATE_KEY }}
        run: |
          if [ -z "$APP_PRIVATE_KEY" ]; then
            echo "Missing APP_PRIVATE_KEY" >&2
            exit 2
          fi
          echo "$APP_PRIVATE_KEY" > /tmp/app.pem
          chmod 600 /tmp/app.pem

      - name: ðŸ” Generate JWT
        id: gen_jwt
        env:
          APP_ID: ${{ secrets.APP_ID }}
        run: |
          if [ -z "$APP_ID" ]; then
            echo "Missing APP_ID" >&2
            exit 2
          fi
          now=$(date +%s)
          iat=$now
          exp=$((now + 600))
          header=$(printf '%s' '{"alg":"RS256","typ":"JWT"}' | openssl base64 -e -A | tr '+/' '-_' | tr -d '=')
          payload=$(printf '%s' "{\"iat\":${iat},\"exp\":${exp},\"iss\":${APP_ID}}" | openssl base64 -e -A | tr '+/' '-_' | tr -d '=')
          unsigned="$header.$payload"
          signature=$(printf '%s' "$unsigned" | openssl dgst -sha256 -sign /tmp/app.pem | openssl base64 -A | tr '+/' '-_' | tr -d '=')
          jwt="$unsigned.$signature"
          echo "jwt=$jwt" >> $GITHUB_OUTPUT

      - name: ðŸ”‘ Request installation token (auto-discover installation)
        id: request_token
        run: |
          # Determine JWT
          JWT=$(cat $GITHUB_OUTPUT | sed -n 's/^jwt=//p' | tr -d '\r' || true)
          if [ -z "$JWT" ]; then
            echo "JWT not found in GITHUB_OUTPUT, attempting from env..."
            JWT=${{ secrets.APP_JWT || '' }}
          fi
          if [ -z "$JWT" ]; then
            echo "JWT creation failed" >&2
            exit 3
          fi

          # Use the repository context to find the installation ID
          if [ -z "$GITHUB_REPOSITORY" ]; then
            echo "GITHUB_REPOSITORY not set" >&2
            exit 4
          fi
          echo "Discovering installation for repo: $GITHUB_REPOSITORY"
          resp=$(curl -s -H "Authorization: Bearer $JWT" -H "Accept: application/vnd.github+json" "https://api.github.com/repos/$GITHUB_REPOSITORY/installation")
          installation_id=$(echo "$resp" | jq -r .id)
          if [ -z "$installation_id" ] || [ "$installation_id" = "null" ]; then
            echo "Failed to find installation for $GITHUB_REPOSITORY: $resp" >&2
            exit 5
          fi

          # Request an installation access token
          resp2=$(curl -s -X POST -H "Authorization: Bearer $JWT" -H "Accept: application/vnd.github+json" "https://api.github.com/app/installations/${installation_id}/access_tokens")
          token=$(echo "$resp2" | jq -r .token)
          if [ -z "$token" ] || [ "$token" = "null" ]; then
            echo "Failed to obtain installation token: $resp2" >&2
            exit 6
          fi
          echo "token=$token" >> $GITHUB_OUTPUT
