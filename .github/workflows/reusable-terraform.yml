name: ðŸ”„ Reusable Terraform Operations

on:
  workflow_call:
    inputs:
      command:
        required: true
        type: string
        description: 'Terraform command to run (init, validate, deploy, destroy)'
      var_file:
        required: false
        type: string
        description: 'Variable file to use'
      aws_region:
        required: false
        type: string
        default: 'ap-southeast-2'
        description: 'AWS region'
      environment_name:
        required: false
        type: string
        description: 'Environment name for state key (e.g., pr-123)'
      artifact_name:
        required: false
        type: string
        description: 'Name of the artifact to download'
      pr_number:
        required: false
        type: string
        description: 'PR number for tagging'
    outputs:
      gateway_url:
        description: 'API Gateway URL output'
        value: ${{ jobs.terraform.outputs.gateway_url }}
      client_id:
        description: 'Entra app client ID'
        value: ${{ jobs.terraform.outputs.client_id }}
      scope:
        description: 'Entra app scope'
        value: ${{ jobs.terraform.outputs.scope }}

permissions:
  id-token: write
  contents: read

jobs:
  terraform:
    runs-on: ubuntu-24.04-arm
    env:
      AWS_REGION: ${{ inputs.aws_region }}
    outputs:
      gateway_url: ${{ steps.terraform-outputs.outputs.gateway_url }}
      client_id: ${{ steps.terraform-outputs.outputs.client_id }}
      scope: ${{ steps.terraform-outputs.outputs.scope }}
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v5

      - name: â˜ï¸ Download Lambda Artifacts
        if: inputs.artifact_name && inputs.artifact_name != 'dummy-artifact'
        uses: actions/download-artifact@v6
        with:
          name: ${{ inputs.artifact_name }}
          path: .

      - name: ðŸ“ Create Environment Variables File
        if: inputs.environment_name
        run: |
          cat > iac/pr-environment.tfvars << EOF
          project_name = "aws-agentcore-gateway-${{ inputs.environment_name }}"
          common_tags = {
            Project     = "aws-agentcore-gateway"
            ManagedBy   = "terraform"
            Environment = "ephemeral-${{ inputs.environment_name }}"
            PR_Number   = "${{ inputs.pr_number || github.event.number }}"
            Branch      = "${{ github.head_ref }}"
          }
          EOF

      - name: ðŸ’¾ Cache Terraform plugins
        uses: actions/cache@v4
        with:
          path: |
            iac/.terraform
            ~/.terraform.d/
          key: ${{ runner.os }}-${{ runner.arch }}-terraform-${{ hashFiles('**/iac/.terraform.lock.hcl', 'iac/main.tf', 'iac/providers.tf') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-terraform-
      
      - name: ðŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      - name: ðŸŽ¨ Terraform Format Check
        if: inputs.command == 'init'
        run: cd iac && terraform fmt -check

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ inputs.aws_region }}

      - name: ðŸ” Configure Azure Credentials
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: ðŸš€ Terraform Init
        env:
          TF_BACKEND_BUCKET: ${{ secrets.TF_BACKEND_BUCKET }}
          TF_VAR_project_name_suffix: ${{ secrets.PROJECT_NAME_SUFFIX || '' }}
        run: |
          cd iac
          if [ -n "${{ inputs.environment_name }}" ]; then
            STATE_KEY="aws-lambda-mcp/${{ inputs.environment_name }}/terraform.tfstate"
          else
            STATE_KEY="aws-lambda-mcp/terraform.tfstate"
          fi
          # Use -reconfigure for PR environments to handle backend config changes
          # Issue: GitHub Actions caches Terraform state between jobs, but PR environments
          # use different state keys than main environment, causing "Backend configuration changed" errors
          # Solution: Use -reconfigure for PR environments to avoid state migration conflicts
          if [ -n "${{ inputs.environment_name }}" ]; then
            terraform init -reconfigure \
              -backend-config="bucket=${TF_BACKEND_BUCKET}" \
              -backend-config="key=${STATE_KEY}" \
              -backend-config="region=${{ inputs.aws_region }}" \
              -backend-config="use_lockfile=true"
          else
            terraform init \
              -backend-config="bucket=${TF_BACKEND_BUCKET}" \
              -backend-config="key=${STATE_KEY}" \
              -backend-config="region=${{ inputs.aws_region }}" \
              -backend-config="use_lockfile=true"
          fi

      - name: âœ… Terraform Validate
        if: inputs.command == 'validate' || inputs.command == 'deploy'
        run: cd iac && terraform validate

      - name: ðŸš€ Terraform Deploy (Plan + Apply)
        if: inputs.command == 'deploy'
        run: |
          cd iac
          terraform plan -out=tfplan ${{ inputs.var_file && format('-var-file={0}', inputs.var_file) || '' }}
          terraform apply tfplan

      - name: ðŸ’¥ Terraform Destroy
        if: inputs.command == 'destroy'
        run: |
          cd iac
          terraform destroy -auto-approve ${{ inputs.var_file && format('-var-file={0}', inputs.var_file) || '' }}

      - name: ðŸ“¤ Capture Terraform Outputs
        if: inputs.command == 'deploy'
        id: terraform-outputs
        run: |
          cd iac
          echo "gateway_url=$(terraform output -raw agentcore_gateway_url 2>/dev/null || echo "")" >> $GITHUB_OUTPUT
          echo "client_id=$(terraform output -raw entra_app_client_id 2>/dev/null || echo "")" >> $GITHUB_OUTPUT
          echo "scope=$(terraform output -raw entra_app_scope_client_credentials 2>/dev/null || echo "")" >> $GITHUB_OUTPUT