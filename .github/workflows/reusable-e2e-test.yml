name: üß™ Reusable E2E Test

on:
  workflow_call:
    inputs:
      gateway_url:
        required: true
        type: string
        description: 'API Gateway URL'
      scope:
        required: true
        type: string
        description: 'Entra app scope'
      client_id:
        required: true
        type: string
        description: 'Entra app client ID'
      environment_name:
        required: true
        type: string
        description: 'Environment name (e.g. preview-123)'
    secrets:
      AZURE_CLIENT_ID:
        required: true
      AZURE_TENANT_ID:
        required: true
      OPENCODE_API_KEY:
        required: true

jobs:
  e2e-test:
    name: üß™ E2E Test & Verify
    runs-on: ubuntu-24.04-arm
    permissions:
      id-token: write
      contents: read
      pull-requests: write # For commenting
    steps:
      - name: üîê Configure Azure Credentials
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: üîë Get OAuth Token
        id: get-token
        run: |
          TOKEN=$(az account get-access-token --scope "${{ inputs.scope }}" --query accessToken -o tsv)
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: üì• Install opencode
        run: curl -fsSL https://opencode.ai/install | bash

      - name: üß™ E2E Test - AI Dynamic Discovery
        env:
          OPENCODE_API_KEY: ${{ secrets.OPENCODE_API_KEY }}
        run: |
          GATEWAY_URL="${{ inputs.gateway_url }}"
          TOKEN="${{ steps.get-token.outputs.token }}"
          
          echo "üîç Discovering tools..."
          TOOLS_JSON=$(curl -s -X POST "$GATEWAY_URL" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"jsonrpc": "2.0", "method": "tools/list", "id": 1}')
            
          echo "Tools response: $TOOLS_JSON"
          
          echo "üß† Generating test inputs using AI..."
          # Use opencode to generate valid arguments for each tool based on its schema
          INPUTS_JSON=$(opencode run -m opencode/grok-code "You are a QA engineer. Given this MCP tools list response, generate a single valid JSON object where keys are the tool names and values are valid argument objects for testing that tool. Return ONLY the raw JSON with no markdown formatting. Schema: $TOOLS_JSON")
          
          echo "Generated Inputs: $INPUTS_JSON"
          
          # Parse tool names
          TOOL_NAMES=$(echo "$TOOLS_JSON" | jq -r '.result.tools[].name')
          
          if [ -z "$TOOL_NAMES" ]; then
            echo "‚ùå No tools found!"
            exit 1
          fi
          
          FAILED=0
          
          for TOOL in $TOOL_NAMES; do
            echo "‚ñ∂Ô∏è Testing tool: $TOOL"
            
            # Extract args for this tool from AI response
            ARGS=$(echo "$INPUTS_JSON" | jq -c ".\"$TOOL\" // {}")
            
            echo "Calling $TOOL with args: $ARGS"
            RESPONSE=$(curl -s -X POST "$GATEWAY_URL" \
              -H "Authorization: Bearer $TOKEN" \
              -H "Content-Type: application/json" \
              -d "{
                \"jsonrpc\": \"2.0\",
                \"id\": 2,
                \"method\": \"tools/call\",
                \"params\": {
                  \"name\": \"$TOOL\",
                  \"arguments\": $ARGS
                }
              }")
            
            echo "Response: $RESPONSE"
            
            if echo "$RESPONSE" | jq -e '.result.content[0].text' >/dev/null 2>&1; then
              echo "‚úÖ Tool execution passed"
            else
              echo "‚ùå Tool execution failed"
              FAILED=1
            fi
          done
          
          if [ $FAILED -ne 0 ]; then
            echo "‚ùå One or more tools failed tests"
            exit 1
          fi

      - name: üí¨ Post Deployment Comment
        if: github.event_name == 'pull_request'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          GATEWAY_URL="${{ inputs.gateway_url }}"
          CLIENT_ID="${{ inputs.client_id }}"
          SCOPE="${{ inputs.scope }}"
          ENVIRONMENT="${{ inputs.environment_name }}"
          
          COMMENT="## üå± Ephemeral Environment Deployed ‚úÖ
          
          Your Preview environment has been deployed successfully!
          
          üîó **Gateway URL**: $GATEWAY_URL
          
          üß™ **Testing Instructions**:
          1. Copy the gateway URL above
          2. Launch the MCP Inspector: \`npx @modelcontextprotocol/inspector --transport http --server-url \"$GATEWAY_URL\"\`
          3. Use an OAuth token to authenticate in the Inspector UI
          
          üîê **Token Generation** (run locally with Azure CLI):
          \`\`\`bash
          # Recommended: Use Azure CLI with the preview environment's scope
          az account get-access-token --resource $SCOPE --query accessToken -o tsv
          
          # Alternative: Manual client credentials flow
          curl -X POST \"https://login.microsoftonline.com/${{ secrets.AZURE_TENANT_ID }}/oauth2/v2.0/token\" \\
            -H \"Content-Type: application/x-www-form-urlencoded\" \\
            -d \"client_id=$CLIENT_ID\" \\
            -d \"client_secret=<CLIENT_SECRET_FROM_TERRAFORM_OUTPUT>\" \\
            -d \"grant_type=client_credentials\" \\
            -d \"scope=$SCOPE\"
          \`\`\`
          
          üìã **Environment Details**:
          - Environment: \`$ENVIRONMENT\`
          - Branch: \`${{ github.head_ref }}\`
          - Client ID: \`$CLIENT_ID\`
          - Scope: \`$SCOPE\`
          
          ‚ÑπÔ∏è This environment will be automatically destroyed when the PR is closed or merged."
          
          gh api repos/${{ github.repository }}/issues/${{ github.event.number }}/comments -f body="$COMMENT" >/dev/null 2>&1 || true
