name: üöÄ Deploy AWS Lambda MCP

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'Makefile'
      - 'iac/**'
  workflow_dispatch: # Allows manual triggering

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: ap-southeast-2 # Default AWS region, can be overridden
  CARGO_TERM_COLOR: always # Ensure Rust color output is consistent

jobs:
  build-lambda:
    name: üß± Build Lambda
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04-arm
    permissions:
      contents: read

    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v5

      - name: ‚öôÔ∏è Setup Rust toolchain
        id: rust-toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rust-src
          targets: aarch64-unknown-linux-gnu

      - name: üíæ Cache Rust dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ runner.arch }}-cargo-${{ steps.rust-toolchain.outputs.rustc_hash }}-${{ hashFiles('**/Cargo.lock', '**/Cargo.toml', 'rust-toolchain.toml') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-cargo-${{ steps.rust-toolchain.outputs.rustc_hash }}-
            ${{ runner.os }}-${{ runner.arch }}-cargo-

      - name: üíæ Cache cargo-lambda
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-lambda
          key: ${{ runner.os }}-${{ runner.arch }}-cargo-lambda-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-lambda-

      - name: üîß Install cargo-lambda
        run: |
          if ! command -v cargo-lambda &> /dev/null
          then
            cargo install cargo-lambda
          fi

      - name: üîß Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: latest

      - name: üì¶ Install UPX (for release build compression)
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: upx-ucl

      - name: üõ†Ô∏è Build Lambda (Release)
        run: make release

      - name: ‚òÅÔ∏è Upload Lambda build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: lambda-build
          path: |
            target/lambda/
            tool_schema.json
          retention-days: 7

  prepare_deployment:
    name: üîß Prepare Deployment
    needs: build-lambda
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-24.04-arm
    permissions:
      id-token: write
      contents: read
    steps:
      - name: üì¶ Checkout code
        uses: actions/checkout@v5

      - name: ‚òÅÔ∏è Download Lambda build artifacts
        uses: actions/download-artifact@v4
        with:
          name: lambda-build
          path: .

      - name: üîê Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: üíæ Cache Terraform plugins
        uses: actions/cache@v4
        with:
          path: |
            iac/.terraform
            ~/.terraform.d/
          key: ${{ runner.os }}-${{ runner.arch }}-terraform-${{ hashFiles('**/iac/.terraform.lock.hcl', 'iac/main.tf', 'iac/providers.tf') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-terraform-
            
      - name: üìù Prepare Backend Config
        run: |
          echo "bucket=${{ secrets.TF_BACKEND_BUCKET }}" > iac/backend-deploy.config
          echo "key=aws-lambda-mcp/terraform.tfstate" >> iac/backend-deploy.config
          echo "region=${{ env.AWS_REGION }}" >> iac/backend-deploy.config
          echo "use_lockfile=true" >> iac/backend-deploy.config

  terraform_validate:
    name: ‚úÖ Terraform Validate
    needs: prepare_deployment
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      command: 'validate'
      backend_config: 'backend-deploy.config'

  terraform_plan:
    name: üìã Terraform Plan
    needs: terraform_validate
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      command: 'plan'
      backend_config: 'backend-deploy.config'
      
  terraform_apply:
    name: üöÄ Terraform Apply
    needs: terraform_plan
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      command: 'apply'
      backend_config: 'backend-deploy.config'
      
  health_check:
    name: üè• MCP Health Check
    needs: terraform_apply
    runs-on: ubuntu-24.04-arm
    steps:
      - name: üè• MCP Health Check
        run: |
          # Get required values from reusable workflow outputs
          CLIENT_ID=${{ needs.terraform_apply.outputs.client_id }}
          TENANT_ID=${{ needs.terraform_apply.outputs.tenant_id }}
          CLIENT_SECRET=${{ needs.terraform_apply.outputs.client_secret }}
          SCOPE=${{ needs.terraform_apply.outputs.scope }}
          GATEWAY_URL=${{ needs.terraform_apply.outputs.gateway_url }}

          # Get OAuth token using client credentials flow
          TOKEN_RESPONSE=$(curl -s -X POST "https://login.microsoftonline.com/$TENANT_ID/oauth2/v2.0/token" \
            -H "Content-Type: application/x-www-form-urlencoded" \
            -d "client_id=$CLIENT_ID" \
            -d "client_secret=$CLIENT_SECRET" \
            -d "grant_type=client_credentials" \
            -d "scope=$SCOPE")

          ACCESS_TOKEN=$(echo "$TOKEN_RESPONSE" | jq -r ".access_token")

          # Test MCP initialize call with token
          RESPONSE=$(curl -s -X POST "$GATEWAY_URL/jsonrpc" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"jsonrpc": "2.0", "id": 1, "method": "initialize", "params": {}}')

          # Validate MCP response
          if echo "$RESPONSE" | jq -e '.result' > /dev/null 2>&1; then
            echo "‚úÖ MCP service healthy"
          else
            echo "‚ùå MCP service unhealthy"
            echo "Response: $RESPONSE"
            exit 1
          fi