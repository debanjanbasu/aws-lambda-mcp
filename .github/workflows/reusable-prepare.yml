name: ðŸ”§ Reusable Prepare Workflow

on:
  workflow_call:
    inputs:
      artifact_name:
        required: true
        type: string
        description: 'Name of the artifact to download'

      environment_name:
        required: false
        type: string
        description: 'Name of the environment (for PRs)'
      pr_number:
        required: false
        type: string
        description: 'PR number (for PRs)'
    outputs:
      environment_name:
        description: 'Environment name'
        value: ${{ jobs.prepare.outputs.environment_name }}
      pr_number:
        description: 'PR number'
        value: ${{ jobs.prepare.outputs.pr_number }}
      action:
        description: 'Action to perform'
        value: ${{ jobs.prepare.outputs.action }}
      
permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  prepare:
    runs-on: ubuntu-24.04-arm
    outputs:
      environment_name: ${{ steps.set-outputs.outputs.environment_name }}
      pr_number: ${{ steps.set-outputs.outputs.pr_number }}
      action: ${{ steps.set-outputs.outputs.action }}
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v5

      - name: â˜ï¸ Download Lambda build artifacts
        if: inputs.artifact_name != 'dummy-artifact'
        uses: actions/download-artifact@v5
        with:
          name: ${{ inputs.artifact_name }}
          path: .



      - name: ðŸ“ Create Environment Variables File
        if: inputs.environment_name
        run: |
          cat > iac/pr-environment.tfvars << EOF
          project_name = "aws-agentcore-gateway-${{ inputs.environment_name }}"
          common_tags = {
            Project     = "aws-agentcore-gateway"
            ManagedBy   = "terraform"
            Environment = "ephemeral-${{ inputs.environment_name }}"
            PR_Number   = "${{ inputs.pr_number }}"
            Branch      = "${{ github.head_ref }}"
          }
          EOF

      - name: â˜ï¸ Upload Environment Config
        if: inputs.environment_name
        uses: actions/upload-artifact@v5
        with:
          name: 'pr-environment-config'
          path: iac/pr-environment.tfvars
          retention-days: 1

      - name: ðŸ“ Set Outputs
        id: set-outputs
        run: |
          echo "environment_name=${{ inputs.environment_name }}" >> $GITHUB_OUTPUT
          echo "pr_number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          if [ "${{ github.event.action }}" = "closed" ]; then
            echo "action=destroy" >> $GITHUB_OUTPUT
          else
            echo "action=deploy" >> $GITHUB_OUTPUT
          fi
