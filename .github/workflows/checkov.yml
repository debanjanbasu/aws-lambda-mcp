# .github/workflows/checkov.yml
name: "üîí Terraform Security Scan (Checkov)"

on:
  push:
    branches: [ "main" ]
    paths:
      - 'iac/**'
      - '.github/workflows/checkov.yml'
  pull_request:
    branches: [ "main" ]
    paths:
      - 'iac/**'
      - '.github/workflows/checkov.yml'
  schedule:
    - cron: '30 2 * * 1' # Match the CodeQL schedule for consistency

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read # for actions/checkout to fetch code
  security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
  actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status

jobs:
  checkov:
    name: üîç Checkov scan
    runs-on: ubuntu-24.04-arm

    steps:
      - name: üì¶ Checkout repository
        uses: actions/checkout@v5

      - name: üêç Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x' # Latest Python 3.x

      - name: üõ°Ô∏è Run Checkov
        uses: bridgecrewio/checkov-action@master
        with:
          # Point the action to your Terraform code directory
          directory: 'iac'
          framework: 'terraform'
          # Output in SARIF format for GitHub Security tab
          output_format: 'sarif'
          output_file_path: 'checkov.sarif'
          # Don't fail the workflow if issues are found
          soft_fail: true

      - name: ‚òÅÔ∏è Upload SARIF to Security Tab
        if: always()
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: 'checkov.sarif'
