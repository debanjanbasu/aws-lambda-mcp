name: ðŸ”„ Reusable Terraform Operations

on:
  workflow_call:
    inputs:
      command:
        required: true
        type: string
        description: 'Terraform command to run (init, validate, deploy, destroy)'
      var_file:
        required: false
        type: string
        description: 'Variable file to use'
      aws_region:
        required: false
        type: string
        default: 'ap-southeast-2'
        description: 'AWS region'
      environment_name:
        required: false
        type: string
        description: 'Environment name for state key (e.g., pr-123)'
      artifact_name:
        required: false
        type: string
        description: 'Name of the artifact to download'
      pr_number:
        required: false
        type: string
        description: 'PR number for tagging'
    outputs:
      gateway_url:
        description: 'API Gateway URL output'
        value: ${{ jobs.terraform.outputs.gateway_url }}
      lambda_function_name:
        description: 'Lambda function name output'
        value: ${{ jobs.terraform.outputs.lambda_function_name }}
      lambda_function_arn:
        description: 'Lambda function ARN'
        value: ${{ jobs.terraform.outputs.lambda_function_arn }}
      lambda_role_arn:
        description: 'Lambda execution role ARN'
        value: ${{ jobs.terraform.outputs.lambda_role_arn }}
      cloudwatch_log_group_name:
        description: 'CloudWatch log group name'
        value: ${{ jobs.terraform.outputs.cloudwatch_log_group_name }}
      agentcore_gateway_id:
        description: 'AgentCore Gateway ID'
        value: ${{ jobs.terraform.outputs.agentcore_gateway_id }}
      agentcore_gateway_arn:
        description: 'AgentCore Gateway ARN'
        value: ${{ jobs.terraform.outputs.agentcore_gateway_arn }}
      aws_region:
        description: 'AWS region'
        value: ${{ jobs.terraform.outputs.aws_region }}
      client_id:
        description: 'Entra app client ID'
        value: ${{ jobs.terraform.outputs.client_id }}
      tenant_id:
        description: 'Entra tenant ID'
        value: ${{ jobs.terraform.outputs.tenant_id }}
      client_secret:
        description: 'Entra client secret'
        value: ${{ jobs.terraform.outputs.client_secret }}
      scope:
        description: 'Entra app scope'
        value: ${{ jobs.terraform.outputs.scope }}

permissions:
  id-token: write
  contents: read

jobs:
  terraform:
    runs-on: ubuntu-24.04-arm
    env:
      AWS_REGION: ${{ inputs.aws_region }}
    outputs:
      gateway_url: ${{ steps.terraform-outputs.outputs.gateway_url }}
      lambda_function_name: ${{ steps.terraform-outputs.outputs.lambda_function_name }}
      lambda_function_arn: ${{ steps.terraform-outputs.outputs.lambda_function_arn }}
      lambda_role_arn: ${{ steps.terraform-outputs.outputs.lambda_role_arn }}
      cloudwatch_log_group_name: ${{ steps.terraform-outputs.outputs.cloudwatch_log_group_name }}
      agentcore_gateway_id: ${{ steps.terraform-outputs.outputs.agentcore_gateway_id }}
      agentcore_gateway_arn: ${{ steps.terraform-outputs.outputs.agentcore_gateway_arn }}
      aws_region: ${{ steps.terraform-outputs.outputs.aws_region }}
      client_id: ${{ steps.terraform-outputs.outputs.client_id }}
      tenant_id: ${{ steps.terraform-outputs.outputs.tenant_id }}
      client_secret: ${{ steps.terraform-outputs.outputs.client_secret }}
      scope: ${{ steps.terraform-outputs.outputs.scope }}
    steps:
      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v5

      - name: â˜ï¸ Download Lambda Artifacts
        if: inputs.artifact_name && inputs.artifact_name != 'dummy-artifact'
        uses: actions/download-artifact@v5
        with:
          name: ${{ inputs.artifact_name }}
          path: .

      - name: ðŸ“ Create Environment Variables File
        if: inputs.environment_name
        run: |
          cat > iac/pr-environment.tfvars << EOF
          project_name = "aws-agentcore-gateway-${{ inputs.environment_name }}"
          common_tags = {
            Project     = "aws-agentcore-gateway"
            ManagedBy   = "terraform"
            Environment = "ephemeral-${{ inputs.environment_name }}"
            PR_Number   = "${{ inputs.pr_number || github.event.number }}"
            Branch      = "${{ github.head_ref }}"
          }
          EOF

      - name: ðŸ’¾ Cache Terraform plugins
        uses: actions/cache@v4
        with:
          path: |
            iac/.terraform
            ~/.terraform.d/
          key: ${{ runner.os }}-${{ runner.arch }}-terraform-${{ hashFiles('**/iac/.terraform.lock.hcl', 'iac/main.tf', 'iac/providers.tf') }}
          restore-keys: |
            ${{ runner.os }}-${{ runner.arch }}-terraform-
      
      - name: ðŸ—ï¸ Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: latest

      - name: ðŸŽ¨ Terraform Format Check
        if: inputs.command == 'init'
        run: cd iac && terraform fmt -check

      - name: ðŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ inputs.aws_region }}

      - name: ðŸ” Configure Azure Credentials
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: ðŸš€ Terraform Init
        env:
          TF_BACKEND_BUCKET: ${{ secrets.TF_BACKEND_BUCKET }}
        run: |
          cd iac
          if [ -n "${{ inputs.environment_name }}" ]; then
            STATE_KEY="aws-lambda-mcp/${{ inputs.environment_name }}/terraform.tfstate"
          else
            STATE_KEY="aws-lambda-mcp/terraform.tfstate"
          fi
          terraform init \
            -backend-config="bucket=${TF_BACKEND_BUCKET}" \
            -backend-config="key=${STATE_KEY}" \
            -backend-config="region=${{ inputs.aws_region }}" \
            -backend-config="use_lockfile=true"

      - name: âœ… Terraform Validate
        if: inputs.command == 'validate' || inputs.command == 'deploy'
        run: cd iac && terraform validate

      - name: ðŸš€ Terraform Deploy (Plan + Apply)
        if: inputs.command == 'deploy'
        run: |
          cd iac
          terraform plan -out=tfplan ${{ inputs.var_file && format('-var-file={0}', inputs.var_file) || '' }}
          terraform apply tfplan

      - name: ðŸ’¥ Terraform Destroy
        if: inputs.command == 'destroy'
        run: |
          cd iac
          terraform destroy -auto-approve ${{ inputs.var_file && format('-var-file={0}', inputs.var_file) || '' }}

      - name: ðŸ“¤ Capture Terraform Outputs
        if: inputs.command == 'deploy'
        id: terraform-outputs
        run: |
          cd iac
          echo "gateway_url=$(terraform output -raw agentcore_gateway_url 2>/dev/null || echo "")" >> $GITHUB_OUTPUT
          echo "lambda_function_name=$(terraform output -raw lambda_function_name 2>/dev/null || echo "")" >> $GITHUB_OUTPUT
          echo "lambda_function_arn=$(terraform output -raw lambda_function_arn 2>/dev/null || echo "")" >> $GITHUB_OUTPUT
          echo "lambda_role_arn=$(terraform output -raw lambda_role_arn 2>/dev/null || echo "")" >> $GITHUB_OUTPUT
          echo "cloudwatch_log_group_name=$(terraform output -raw cloudwatch_log_group_name 2>/dev/null || echo "")" >> $GITHUB_OUTPUT
          echo "agentcore_gateway_id=$(terraform output -raw agentcore_gateway_id 2>/dev/null || echo "")" >> $GITHUB_OUTPUT
          echo "agentcore_gateway_arn=$(terraform output -raw agentcore_gateway_arn 2>/dev/null || echo "")" >> $GITHUB_OUTPUT
          echo "aws_region=$(terraform output -raw aws_region 2>/dev/null || echo "")" >> $GITHUB_OUTPUT
          echo "client_id=$(terraform output -raw entra_app_client_id 2>/dev/null || echo "")" >> $GITHUB_OUTPUT
          echo "tenant_id=$(terraform output -raw entra_tenant_id 2>/dev/null || echo "")" >> $GITHUB_OUTPUT
          echo "client_secret=$(terraform output -raw entra_client_secret 2>/dev/null || echo "")" >> $GITHUB_OUTPUT
          echo "scope=$(terraform output -raw entra_app_scope_client_credentials 2>/dev/null || echo "")" >> $GITHUB_OUTPUT
          # Available outputs: gateway_url, lambda_function_name, lambda_function_arn,
          # lambda_role_arn, cloudwatch_log_group_name, agentcore_gateway_id,
          # agentcore_gateway_arn, aws_region, client_id, tenant_id, client_secret, scope