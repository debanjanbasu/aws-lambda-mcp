# .github/workflows/automerge-dependabot.yml
name: ü§ñ Dependabot Auto-merge

on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
    paths-ignore:
      - '**.md'
      - '.gitignore'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  statuses: write

env:
  CARGO_TERM_COLOR: always # Ensure Rust color output is consistent
  AWS_REGION: ap-southeast-2 # Default AWS region

jobs:
  automerge:
    name: üîÑ Auto-merge Dependabot PRs
    # Only run on PRs from dependabot that are not in draft
    if: github.event.pull_request.user.login == 'dependabot[bot]' && github.event.pull_request.draft == false
    runs-on: ubuntu-24.04-arm
    outputs:
      is_rust: ${{ steps.detect_pr_type.outputs.IS_RUST_PR }}
      is_terraform: ${{ steps.detect_pr_type.outputs.IS_TERRAFORM_PR }}
    steps:
      - name: üì¶ Checkout PR code
        uses: actions/checkout@v5

      - name: üïµÔ∏è Detect PR type
        id: detect_pr_type
        run: |
          # Determine if this is a Terraform PR based on changed files
          if git diff --name-only HEAD^ HEAD | grep -q "iac/.*\.tf"; then
            echo "IS_TERRAFORM_PR=true" >> $GITHUB_OUTPUT
          else
            echo "IS_TERRAFORM_PR=false" >> $GITHUB_OUTPUT
          fi
          
          # Determine if this is a Rust/Cargo PR
          if git diff --name-only HEAD^ HEAD | grep -q "Cargo\.\(lock\|toml\)"; then
            echo "IS_RUST_PR=true" >> $GITHUB_OUTPUT
          else
            echo "IS_RUST_PR=false" >> $GITHUB_OUTPUT
          fi

      # Rust Dependency Updates
      - name: ‚öôÔ∏è Setup Rust toolchain
        if: steps.detect_pr_type.outputs.IS_RUST_PR == 'true'
        id: rust-toolchain
        uses: dtolnay/rust-toolchain@nightly

      - name: üíæ Cache Rust dependencies
        if: steps.detect_pr_type.outputs.IS_RUST_PR == 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-${{ runner.arch }}-cargo-${{ steps.rust-toolchain.outputs.rustc_hash }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ steps.rust-toolchain.outputs.rustc_hash }}-

      # Terraform Dependency Updates
      - name: ‚úÖ Terraform Validate
        if: steps.detect_pr_type.outputs.IS_TERRAFORM_PR == 'true'
        uses: ./.github/workflows/reusable-terraform.yml
        with:
          command: 'validate'
          backend_config: 'backend.config'

      # Run appropriate tests based on PR type
      - name: üß™ Run Tests
        # For Dependabot PRs, we only run tests to verify compatibility
        run: |
          if [ "${{ steps.detect_pr_type.outputs.IS_RUST_PR }}" = "true" ]; then
            echo "Running Rust tests with latest dependencies..."
            make test || (echo "Rust tests failed - this may indicate breaking changes in dependencies" && exit 1)
           elif [ "${{ steps.detect_pr_type.outputs.IS_TERRAFORM_PR }}" = "true" ]; then
             echo "Terraform configuration already validated above"
             # For Terraform updates, validation was done earlier
          else
            # Fallback to running all tests
            echo "Running all tests..."
            make test || (echo "Tests failed - this may indicate breaking changes" && exit 1)
          fi

      - name: ‚úÖ Approve and Merge
        if: success() # Only run if tests pass
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          gh pr review --approve "$PR_URL"
          gh pr merge --auto --merge "$PR_URL"

      - name: üö® Handle Failure
        if: failure()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          gh pr edit "$PR_URL" --add-label "breaking-change-detected"
          gh pr comment "$PR_URL" --body "## üö® Auto-Merge Failed - Breaking Change Detected

          Tests failed for this Dependabot PR, indicating a potential breaking change in the updated dependencies. An AI agent has been dispatched to attempt a fix.
          
          This is expected behavior as we intentionally use the latest versions to catch breaking changes early.
          
          Next steps:
          1. The AI agent will analyze the failure and push a fix to this branch.
          2. If the agent is successful, the tests will be re-run automatically.
          3. If the agent fails, manual intervention will be required. Review the workflow logs to identify the specific failure."
          
           # Also add a comment with more specific troubleshooting steps
           if [ "${{ steps.detect_pr_type.outputs.IS_RUST_PR }}" = "true" ]; then
            gh pr comment "$PR_URL" --body "For Rust dependency updates:
            - Check the dependency's release notes for breaking changes
            - Run \`cargo check\` locally with the updated dependencies
            - Update the code as needed to work with the new API
            - Run \`make test\` to ensure all tests pass"
          elif [ "${{ steps.detect_pr_type.outputs.IS_TERRAFORM_PR }}" = "true" ]; then
            gh pr comment "$PR_URL" --body "For Terraform provider updates:
            - Check the provider's changelog for breaking changes
            - Run \`cd iac && terraform init\` and \`terraform validate\` locally
            - Update the Terraform configuration as needed"
          fi
