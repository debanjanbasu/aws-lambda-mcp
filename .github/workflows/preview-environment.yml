name: ğŸŒ± Ephemeral Preview Environment
on:
  pull_request:
    types:
      - opened
      - synchronize
      - reopened
      - closed
    paths-ignore:
      - '**.md'
      - '.gitignore'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'deploy'
        type: choice
        options:
          - deploy
          - destroy
      pr_number:
        description: 'PR Number (required for manual trigger)'
        required: true
        type: string
env:
  AWS_REGION: ap-southeast-2
  CARGO_TERM_COLOR: always
concurrency:
  group: ${{ github.workflow }}-${{ github.event.number || inputs.pr_number }}
  cancel-in-progress: true  # Cancels previous runs when new commits are pushed.
                            # Note: Cancelled Terraform operations may leave state locks.
                            # The reusable-terraform workflow automatically detects and clears stale locks.
jobs:
  build-lambda:
    name: ğŸ§± Build Lambda
    if: (github.event_name == 'workflow_dispatch' && inputs.action == 'deploy') || (github.event_name == 'pull_request' && github.event.pull_request.draft == false && github.event.action != 'closed')
    uses: ./.github/workflows/reusable-rust.yml
    with:
      run_tests: true
      run_build: true
      artifact_name: 'preview-lambda-build'
  terraform_validate_preview:
    name: âœ… Terraform Validate (Preview)
    needs: build-lambda
    if: (github.event_name == 'pull_request' && github.event.action != 'closed') || (github.event_name == 'workflow_dispatch' && inputs.action == 'deploy')
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      command: 'validate'
      environment_name: 'preview-${{ github.event.number || inputs.pr_number }}'
      artifact_name: 'preview-lambda-build'
      pull_request_number: '${{ github.event.number || inputs.pr_number }}'
    secrets: inherit
  terraform_apply_preview:
    name: ğŸš€ Terraform Apply (Preview)
    needs: terraform_validate_preview
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      command: 'deploy'
      var_file: 'preview-environment.tfvars'
      environment_name: 'preview-${{ github.event.number || inputs.pr_number }}'
      artifact_name: 'preview-lambda-build'
      pull_request_number: '${{ github.event.number || inputs.pr_number }}'
    secrets: inherit
  e2e_test:
    name: ğŸ§ª E2E Test & Verify
    needs: terraform_apply_preview
    uses: ./.github/workflows/reusable-e2e-test.yml
    with:
      gateway_url: ${{ needs.terraform_apply_preview.outputs.gateway_url }}
      scope: ${{ needs.terraform_apply_preview.outputs.scope }}
      client_id: ${{ needs.terraform_apply_preview.outputs.client_id }}
      environment_name: 'preview-${{ github.event.number }}'
    secrets: inherit
  post_deployment_comment:
    name: ğŸ’¬ Post Deployment Comment
    needs: [terraform_apply_preview, e2e_test]
    if: (github.event_name == 'pull_request' && github.event.action != 'closed') || (github.event_name == 'workflow_dispatch' && inputs.action == 'deploy')
    runs-on: ubuntu-24.04-arm
    permissions:
      pull-requests: write
    steps:
      - name: ğŸ’¬ Post Comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GATEWAY_URL: ${{ needs.terraform_apply_preview.outputs.gateway_url }}
          CLIENT_ID: ${{ needs.terraform_apply_preview.outputs.client_id }}
          SCOPE: ${{ needs.terraform_apply_preview.outputs.scope }}
          ENVIRONMENT: preview-${{ github.event.number || inputs.pr_number }}
          BRANCH: ${{ github.head_ref }}
          PR_NUMBER: ${{ github.event.number || inputs.pr_number }}
          TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          TF_BACKEND_BUCKET: ${{ secrets.TF_BACKEND_BUCKET }}
        run: |
          COMMENT="## ğŸŒ± Ephemeral Environment Deployed âœ…
          Your Preview environment has been deployed successfully!
          ğŸ”— **Gateway URL**: $GATEWAY_URL
          ğŸ§ª **Testing Instructions**:
          1. Copy the gateway URL above
          2. Launch the MCP Inspector: \`npx @modelcontextprotocol/inspector --transport http --server-url \"$GATEWAY_URL\"\`
          3. Use an OAuth token to authenticate in the Inspector UI
          ğŸ” **Token Generation** (run locally with Azure CLI):
          \`\`\`bash
          # Get OAuth token using Azure CLI (Azure CLI is pre-authorized for this app)
          az account get-access-token --resource $CLIENT_ID --query accessToken -o tsv
          \`\`\`
          ğŸ“‹ **Environment Details**:
          - Environment: \`$ENVIRONMENT\`
          - Branch: \`$BRANCH\`
          - Client ID: \`$CLIENT_ID\`
          
          ğŸ› ï¸ **Local Development Setup** (optional):
          To work with this preview environment locally, configure your Terraform backend with this single command:
          \`\`\`bash
          BUCKET_NAME="${{ secrets.TF_BACKEND_BUCKET }}" ENVIRONMENT_NAME="$(echo "$ENVIRONMENT" | sed 's/^preview-//')" make setup-backend && cd iac && terraform init -reconfigure -backend-config=backend.config
          \`\`\`
          
          â„¹ï¸ This environment will be automatically destroyed when the PR is closed or merged."
          gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments -f body="$COMMENT" >/dev/null 2>&1 || true
  terraform_destroy_preview:
    name: ğŸ’£ Terraform Destroy (Preview)
    if: (github.event_name == 'pull_request' && github.event.action == 'closed') || (github.event_name == 'workflow_dispatch' && inputs.action == 'destroy')
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      command: 'destroy'
      var_file: 'preview-environment.tfvars'
      environment_name: 'preview-${{ github.event.number }}'
      pull_request_number: '${{ github.event.number }}'
    secrets: inherit
  cleanup_preview_environment:
    name: ğŸ§¹ Cleanup Preview Environment
    needs: terraform_destroy_preview
    if: (github.event_name == 'pull_request' && github.event.action == 'closed') || (github.event_name == 'workflow_dispatch' && inputs.action == 'destroy')
    runs-on: ubuntu-24.04-arm
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - name: ğŸ” Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: ğŸ§¹ Cleanup Terraform State File
        run: |
          STATE_KEY="aws-lambda-mcp/preview-${{ github.event.number || inputs.pr_number }}/terraform.tfstate"
          echo "Cleaning up Terraform state file: s3://${{ secrets.TF_BACKEND_BUCKET }}/$STATE_KEY"
          aws s3 rm "s3://${{ secrets.TF_BACKEND_BUCKET }}/$STATE_KEY" || echo "State file cleanup may have failed, continuing..."
      - name: ğŸ’¬ Notify Environment Destruction
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COMMENT="## ğŸŒ± Ephemeral Environment Destroyed ğŸ—‘ï¸
          Your Preview environment has been successfully destroyed.
          ğŸ“‹ **Details**:
          - Environment: \`preview-${{ github.event.number || inputs.pr_number }}\`
          - Branch: \`${{ github.head_ref }}\`
          âœ… All resources have been cleaned up."
          gh api repos/${{ github.repository }}/issues/${{ github.event.number || inputs.pr_number }}/comments -f body="$COMMENT" >/dev/null 2>&1 || true