name: ğŸš€ Deploy AWS Lambda MCP

on:
  push:
    branches:
      - main
    paths:
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - 'Makefile'
      - 'iac/**'
  workflow_dispatch: # Allows manual triggering

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: ap-southeast-2 # Default AWS region, can be overridden
  CARGO_TERM_COLOR: always # Ensure Rust color output is consistent

jobs:
  build-lambda:
    name: ğŸ§± Build Lambda
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    uses: ./.github/workflows/reusable-rust.yml
    with:
      run_tests: true
      run_build: true
      artifact_name: 'lambda-build'

  terraform_deploy:
    name: ğŸš€ Terraform Deploy
    needs: build-lambda
    uses: ./.github/workflows/reusable-terraform.yml
    with:
      command: 'deploy'
      aws_region: ${{ vars.AWS_REGION || 'ap-southeast-2' }}
      artifact_name: 'lambda-build'
    secrets: inherit

  e2e_test:
    name: ğŸ§ª E2E Test
    needs: terraform_deploy
    runs-on: ubuntu-24.04-arm
    steps:
      - name: ğŸ” Configure Azure Credentials
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true

      - name: ğŸ”‘ Get OAuth Token
        id: get-token
        run: |
          SCOPE=${{ needs.terraform_deploy.outputs.scope }}
          TOKEN=$(az account get-access-token --resource "$SCOPE" --query accessToken -o tsv)
          echo "::add-mask::$TOKEN"
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: ğŸ§ª E2E Test - Weather Tool
        run: |
          GATEWAY_URL=${{ needs.terraform_deploy.outputs.gateway_url }}
          TOKEN=${{ steps.get-token.outputs.token }}
          
          echo "Testing weather tool via AgentCore Gateway..."
          RESPONSE=$(curl -s -X POST "$GATEWAY_URL" \
            -H "Authorization: Bearer $TOKEN" \
            -H "Content-Type: application/json" \
            -d '{
              "tool": "get_weather",
              "input": {
                "location": "Sydney"
              }
            }')
          
          echo "Response: $RESPONSE"
          
          # Check if response contains expected fields
          if echo "$RESPONSE" | jq -e '.temperature' >/dev/null 2>&1; then
            echo "âœ… E2E test passed - received valid weather response"
          else
            echo "âŒ E2E test failed - invalid response"
            exit 1
          fi